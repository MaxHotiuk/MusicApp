@page "/login"
@using MusicApp.Client.Interfaces
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16 d-flex flex-column align-center">
    <MudPaper Elevation="3" Class="pa-8 mx-auto" Style="max-width: 500px; width: 100%;">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">Login</MudText>
        
        @if (isLoading)
        {
            <div class="d-flex justify-center my-4">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </div>
            <MudText Align="Align.Center">Preparing login...</MudText>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="my-4">@errorMessage</MudAlert>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="RetryLogin">
                Retry
            </MudButton>
        }
        else
        {
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Success" 
                       StartIcon="@Icons.Material.Filled.MusicNote"
                       FullWidth="true"
                       OnClick="LoginWithSpotify">
                Connect with Spotify
            </MudButton>
        }
    </MudPaper>
</MudContainer>

@code {
    private bool isLoading = false;
    private string errorMessage = "";

    private async Task LoginWithSpotify()
    {
        try
        {
            isLoading = true;
            var loginUrl = await AuthService.GetSpotifyLoginUrlAsync();
            
            // Redirect to Spotify authorization page
            NavigationManager.NavigateTo(loginUrl);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to start login process: {ex.Message}";
            Console.WriteLine($"Login error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void RetryLogin()
    {
        errorMessage = "";
    }
}